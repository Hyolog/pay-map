<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>용인와이페이 지도</title>

    <!-- Kakao Maps SDK -->
	<!-- Appkey has domain limit setting so there is no security issue-->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=a9517e460aa86036c7478c3d083449e3&libraries=services,clusterer,drawing"></script>

    <style>
        html, body {
            margin: 0;
            padding: 0;
        }

        /* Top floating search bar and bottom sheet layout adjustments */
        #top-bar {
            position: fixed;
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 24px);
            max-width: 1100px;
            background: rgba(255,255,255,0.95);
            border-radius: 12px;
            padding: 8px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.12);
            z-index: 1000;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        #bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40vh; /* occupy about 40% of screen */
            /* semi-transparent glass look */
            background: rgba(255,255,255,0.6);
            backdrop-filter: blur(6px);
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            box-shadow: 0 -6px 18px rgba(0,0,0,0.12);
            z-index: 900;
            overflow-y: auto;
            padding: 12px;
            box-sizing: border-box;
        }

        /* restore scrollbar and style it for webkit browsers */
        #bottom-sheet::-webkit-scrollbar {
            width: 10px;
        }
        #bottom-sheet::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.04);
            border-radius: 10px;
        }
        #bottom-sheet::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.18);
            border-radius: 10px;
        }
        /* Firefox scrollbar */
        #bottom-sheet {
            scrollbar-width: thin;
            scrollbar-color: rgba(0,0,0,0.18) rgba(0,0,0,0.04);
        }

        #search {
            height: 40px;
            background-color: transparent;
            padding: 0;
            display: flex;
            gap: 8px;
            width: 100%;
            align-items: center;
        }

        #search-name, #search-business-group {
            box-sizing: border-box;  
            border-radius: 8px;
            border: none;
            background-color: #ebebeb;
            padding: 8px 10px;
            font-size: 14px;
        }

        #search-name { flex: 1 1 auto; }
        #search-business-group { width: 180px; flex: 0 0 auto; }

        .store-info {
            padding: 10px;
            border-bottom: 1px solid #f5f5f5;
            font-size: 14px;
            cursor: pointer;
            background: transparent;
        }

        .store-name {
            font-size: 20px;
            font-weight: bold;
            color: #daa520;
        }

        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
        }

        /* Floating location button - positioned relative to adjusted map area (top 60%) */
        #loc-btn {
            position: fixed;
            right: 20px;
            /* default bottom will be set dynamically to sit above the bottom of adjusted area */
            z-index: 1100;
            background: #fff;
            border: none;
            padding: 10px 12px;
            border-radius: 8px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.12);
            cursor: pointer;
            font-weight: 600;
        }

        .customoverlay {
            background-color: #eef3fd;
            border: #536AFF solid 1px;
            border-radius: 5px;
            color: #536AFF;
            font-size: 13px;
            font-weight: 600;
            padding: 5px 11px;
            position: relative;
        }

        .customoverlay:hover {
            background-color: #CBDBFC;
        }

        .customoverlay:after, .customoverlay:before {
            content: '';
            display: block;
            position: absolute;
            left: 50%;
            margin-left: -6px;
        }

        .customoverlay:after {
            border-color: #eef3fd transparent;
            border-width: 8px 6.5px 0;
            top: 26px;
        }

        .customoverlay:hover:after {
            border-color: #CBDBFC transparent;
        }

        .customoverlay:before {
            border-color: #536AFF transparent;
            border-width: 8px 6.5px 0;
            top: 27.5px;
        }

        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #daa520;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body>
    <!-- Busy Indicator-->
    <div id="loading" style="display: none;">
        <div class="spinner"></div>
    </div>

    <!-- Top floating search bar -->
    <div id="top-bar">
        <div id="search">
            <input id="search-name" placeholder="가게 검색" onkeyup="filterStores()" />
            <select id="search-business-group" onchange="filterStores()">
                <option value="">업종 선택</option>
            </select>
        </div>
    </div>

    <!-- Bottom sheet for store list -->
    <div id="bottom-sheet">
        <div id="store-list"></div>
    </div>

    <!-- Floating location button -->
    <button id="loc-btn" aria-label="내 위치로 이동" title="내 위치로 이동" onclick="centerToUser()">내 위치</button>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-latest.js"></script>
    <!-- Local API key for testing (ignored by git). Create apikey.js with window.config.apikey -->
    <script src="apikey.js"></script>

    <script>
        // Geolocation: prompt on load and show floating button if allowed
        var userLocation = null;
        var geolocationPromptShown = false;
        function requestGeolocationOnDemand(callback) {
            if (!navigator.geolocation) {
                callback && callback(new Error('Geolocation not supported'));
                return;
            }
            navigator.geolocation.getCurrentPosition(function(pos) {
                userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                callback && callback(null, userLocation);
            }, function(err) {
                callback && callback(err);
            }, { enableHighAccuracy: false, timeout: 5000 });
        }

        function centerToUser() {
            // show permission prompt only when user first clicks
            if (!geolocationPromptShown) {
                geolocationPromptShown = true;
                requestGeolocationOnDemand(function(err, loc) {
                    if (err) {
                        alert('위치 정보를 사용할 수 없습니다: ' + (err.message || err.code || 'unknown'));
                        return;
                    }
                    positionLocButton();
                    var btn = document.getElementById('loc-btn');
                    if (btn) btn.style.display = 'block';
                    centerUserInAdjustedArea(loc);
                });
                return;
            }

            if (userLocation) {
                centerUserInAdjustedArea(userLocation);
                return;
            }

            // fallback: try to get location again
            requestGeolocationOnDemand(function(err, loc) {
                if (err) { alert('위치 정보를 사용할 수 없습니다: ' + (err.message || err.code || 'unknown')); return; }
                centerUserInAdjustedArea(loc);
            });
        }

        var userMarker = null;
        function centerMapTo(loc) {
            var coords = new kakao.maps.LatLng(loc.lat, loc.lng);
            map.setLevel(4);
            map.setCenter(coords);

            if (userMarker) userMarker.setMap(null);
            userMarker = new kakao.maps.Marker({ position: coords, map: map });
        }

        // center user's location to the middle of adjusted visible area (top 60% center)
        function centerUserInAdjustedArea(loc) {
            var adj = getAdjustedBounds();
            if (!adj) {
                centerMapTo(loc);
                return;
            }

            var adjCenterLat = (adj.sw.getLat() + adj.ne.getLat()) / 2;
            var adjCenterLng = (adj.sw.getLng() + adj.ne.getLng()) / 2;

            var currentCenter = map.getCenter();
            var newCenterLat = currentCenter.getLat() + (loc.lat - adjCenterLat);
            var newCenterLng = currentCenter.getLng() + (loc.lng - adjCenterLng);

            var newCenter = new kakao.maps.LatLng(newCenterLat, newCenterLng);
            map.setLevel(4);
            map.setCenter(newCenter);

            if (userMarker) userMarker.setMap(null);
            var userPos = new kakao.maps.LatLng(loc.lat, loc.lng);
            userMarker = new kakao.maps.Marker({ position: userPos, map: map });
        }

        // request permission on load
        window.addEventListener('load', function() { requestGeolocation(); });
        // Kakao Map Initialization
        var mapContainer = document.getElementById('map');
        var mapOption = {
            center: new kakao.maps.LatLng(37.2415, 127.1775),
            level: 8
        };
        var map = new kakao.maps.Map(mapContainer, mapOption);
        var mapTypeControl = new kakao.maps.MapTypeControl();
        map.addControl(mapTypeControl, kakao.maps.ControlPosition.TOPRIGHT);
        var zoomControl = new kakao.maps.ZoomControl();
        map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);

    // Globals for stores and markers with coordinates
    var allStoresWithCoords = []; // { name, location, businessGroup, lat, lng }
    var markersGlobal = [];
    var clustererGlobal = null;

        (function fetchStoresFromApi() {
            const SERVICE_KEY = config.apikey;
            const NUM_OF_ROWS = 1000;
            const PAGE_NO = 1;

            document.getElementById('loading').style.display = 'flex';

            var url = new URL('https://apis.data.go.kr/4050000/ypay/getYpay');
            url.searchParams.set('serviceKey', SERVICE_KEY);
            url.searchParams.set('numOfRows', NUM_OF_ROWS);
            url.searchParams.set('pageNo', PAGE_NO);

            fetch(url.toString())
                .then(function (res) {
                    if (!res.ok) throw new Error('네트워크 응답 오류: ' + res.status);
                    return res.json();
                })
                .then(function (json) {
                    var items = [];

                    if (json && Array.isArray(json.items)) {
                        items = json.items;
                    } else {
                        console.warn('응답이 예상과 다릅니다. 응답:', json);
                    }

                    var stores = items.map(function (it) {
                        return {
                            name: it.aflt_nm || '',
                            location: it.addr || '',
                            businessGroup: it.fld || '',
                        };
                    }).filter(function(s) {
                        // 주소가 없는 항목들 제거
                        return s.location && s.location.trim().length > 0;
                    });

                    if (stores.length === 0) {
                        console.warn('API로부터 가게 목록을 얻지 못했거나 유효한 가게정보가 없습니다.');
                    }

                    stores.sort(function (a, b) { return a.name.localeCompare(b.name); });

                    makeStoreClusterer({ stores: stores });
                    populateStoreList(stores);
                })
                .catch(function (err) {
                    console.error('가게 정보 API 호출 실패:', err);
                    document.getElementById('loading').style.display = 'none';
                });
        })();

        function makeStoreClusterer(data) {
            document.getElementById('loading').style.display = 'flex';

            clustererGlobal = new kakao.maps.MarkerClusterer({
                map: map,
                averageCenter: true,
                minLevel: 5
            });

            var geocoder = new kakao.maps.services.Geocoder();
            var stores = data.stores;
            var total = stores.length;
            var coords = {};
            var requestInterval = 100; // Request interval
            var chunkSize = 20; // Number of stores to process per batch
            var currentIndex = 0; // Current store index to process

            // Function to send requests sequentially
            function sendNextRequest() {
                if (currentIndex >= total) {
                    // build array of stores with coordinates for easy spatial filtering
                    allStoresWithCoords = stores.filter(function(s) { return coords[s.location]; }).map(function(s) {
                        return {
                            name: s.name,
                            location: s.location,
                            businessGroup: s.businessGroup,
                            lat: coords[s.location].y,
                            lng: coords[s.location].x
                        };
                    });

                    addMarkersToClusterStores(stores, coords, clustererGlobal);

                    // initial render: show stores within current map bounds
                    updateVisibleStoreList();

                    document.getElementById('loading').style.display = 'none';
                    return;
                }

                var chunk = stores.slice(currentIndex, currentIndex + chunkSize);
                currentIndex += chunkSize;

                var requestsRemaining = chunk.length;
                chunk.forEach(function (store) {
                    geocoder.addressSearch(store.location, function (data, status) {
                        if (status === kakao.maps.services.Status.OK) {
                            coords[store.location] = data[0];
                        } else {
                            console.warn('위치 정보 변환 실패:', store.location, status);
                        }
                        requestsRemaining--;

                        if (requestsRemaining === 0) {
                            setTimeout(sendNextRequest, requestInterval);
                        }
                    });
                });
            }

            sendNextRequest();
        }

        function addMarkersToClusterStores(stores, coords, clusterer) {
            // remove previous markers
            markersGlobal.forEach(function(m) { m.setMap(null); });
            markersGlobal = [];

            var markers = [];
            stores.forEach(function (store) {
                if (coords[store.location]) {
                    var pos = new kakao.maps.LatLng(coords[store.location].y, coords[store.location].x);
                    var marker = new kakao.maps.Marker({ position: pos });
                    var content = `<div class="customoverlay">${store.name}</div>`;
                    var overlay = new kakao.maps.CustomOverlay({ content, map: map, position: pos, yAnchor: 2.1 });

                    marker.addListener('click', function () {
                        overlay.setMap(map);
                        setTimeout(function () { overlay.setMap(null); }, 3000);
                    });

                    markers.push(marker);
                    markersGlobal.push({ marker: marker, store: store, lat: coords[store.location].y, lng: coords[store.location].x });
                    overlay.setMap(null);
                }
            });
            clusterer.addMarkers(markers);

            // cluster click: when a cluster is clicked, show only stores inside cluster bounds
            kakao.maps.event.addListener(clusterer, 'clusterclick', function(cluster) {
                var clusteredMarkers = cluster.getMarkers();
                // compute a set of locations from clustered markers
                var clusteredCoords = clusteredMarkers.map(function(cm) {
                    var p = cm.getPosition(); return { lat: p.getLat(), lng: p.getLng() };
                });

                // find stores whose coords match clustered coords (loose match)
                var clusteredStores = allStoresWithCoords.filter(function(s) {
                    return clusteredCoords.some(function(cc) { return Math.abs(cc.lat - s.lat) < 1e-6 && Math.abs(cc.lng - s.lng) < 1e-6; });
                });

                // filter by adjusted visible bounds (exclude area covered by bottom-sheet/top-bar)
                var visibleClustered = clusteredStores.filter(function(s) { return isInAdjustedBounds(s.lat, s.lng); });

                renderStoreList(visibleClustered);
            });
        }

        function populateStoreList(stores) {
            // populate only business group select; rendering of list is handled by renderStoreList
            const tempBusinessGroupList = [];
            stores.forEach(function (s) { tempBusinessGroupList.push(s.businessGroup); });
            populateBusinessGroupSelect(tempBusinessGroupList);
        }

        function renderStoreList(stores) {
            const storeList = document.getElementById('store-list');
            storeList.innerHTML = '';
            storeList.style.maxHeight = 'calc(40vh - 24px)';
            storeList.style.overflowY = 'auto';

            stores.forEach(function (store) {
                var storeInfoSection = document.createElement("section");
                storeInfoSection.className = 'store-info';
                storeInfoSection.tabIndex = "0";

                // attach click handler that recenters map to the store coords
                storeInfoSection.addEventListener("mouseup", function() {
                    if (store.lat && store.lng) {
                        var coords = new kakao.maps.LatLng(store.lat, store.lng);
                        map.setLevel(4);
                        map.setCenter(coords);
                    } else {
                        moveToStoreLocation.call(this);
                    }
                });

                var storeNameDiv = document.createElement("div");
                storeNameDiv.className = 'store-name';
                storeNameDiv.innerHTML = store.name;
                storeInfoSection.appendChild(storeNameDiv);

                var storeLocationDiv = document.createElement("div");
                storeLocationDiv.className = 'store-location';
                storeLocationDiv.innerHTML = store.location;
                storeInfoSection.appendChild(storeLocationDiv);

                var storeBusinessGroupDiv = document.createElement("div");
                storeBusinessGroupDiv.className = 'store-business-group';
                storeBusinessGroupDiv.innerHTML = store.businessGroup;
                storeInfoSection.appendChild(storeBusinessGroupDiv);

                storeList.appendChild(storeInfoSection);
            });
        }

        function updateVisibleStoreList() {
            if (!allStoresWithCoords || allStoresWithCoords.length === 0) return;
            var adj = getAdjustedBounds();
            if (!adj) return;

            var sw = adj.sw;
            var ne = adj.ne;

            var visible = allStoresWithCoords.filter(function(s) {
                return s.lat >= sw.getLat() && s.lat <= ne.getLat() && s.lng >= sw.getLng() && s.lng <= ne.getLng();
            });

            renderStoreList(visible);
        }

        // compute adjusted bounds that exclude areas covered by top-bar and bottom-sheet
        function getAdjustedBounds() {
            var bounds = map.getBounds();
            if (!bounds) return null;
            var sw = bounds.getSouthWest();
            var ne = bounds.getNorthEast();

            var heightPx = window.innerHeight || document.documentElement.clientHeight;
            var topEl = document.getElementById('top-bar');
            var bottomEl = document.getElementById('bottom-sheet');
            var topH = topEl ? topEl.offsetHeight : 0;
            var bottomH = bottomEl ? bottomEl.offsetHeight : 0;

            var latSpan = ne.getLat() - sw.getLat();

            var topFraction = topH / heightPx;
            var bottomFraction = bottomH / heightPx;

            // shrink lat bounds accordingly: move ne down by topFraction*latSpan, move sw up by bottomFraction*latSpan
            var adjNeLat = ne.getLat() - (latSpan * topFraction);
            var adjSwLat = sw.getLat() + (latSpan * bottomFraction);

            // longitude unaffected by vertical overlays; return new bounds using kakao LatLng
            return {
                sw: new kakao.maps.LatLng(adjSwLat, sw.getLng()),
                ne: new kakao.maps.LatLng(adjNeLat, ne.getLng())
            };
        }

        function isInAdjustedBounds(lat, lng) {
            var adj = getAdjustedBounds();
            if (!adj) return false;
            return lat >= adj.sw.getLat() && lat <= adj.ne.getLat() && lng >= adj.sw.getLng() && lng <= adj.ne.getLng();
        }

        // update list when map view changes
        kakao.maps.event.addListener(map, 'idle', function() {
            updateVisibleStoreList();
        });
        kakao.maps.event.addListener(map, 'zoom_changed', function() {
            updateVisibleStoreList();
        });

        // wire location button
        document.addEventListener('DOMContentLoaded', function() {
            var btn = document.getElementById('loc-btn');
            if (btn) {
                btn.addEventListener('click', centerToUser);
                // position button within adjusted area
                positionLocButton();
                window.addEventListener('resize', positionLocButton);
                kakao.maps.event.addListener(map, 'idle', positionLocButton);
            }
        });

        function positionLocButton() {
            var btn = document.getElementById('loc-btn');
            if (!btn) return;
            var adj = getAdjustedBounds();
            var bottomSheet = document.getElementById('bottom-sheet');
            var mapDiv = document.getElementById('map');
            var mapRect = mapDiv.getBoundingClientRect();

            if (!adj) {
                btn.style.bottom = (bottomSheet.offsetHeight + 16) + 'px';
                return;
            }

            // We want the button in the bottom-right corner of the adjusted visible area.
            // Compute adjusted area's bottom pixel position relative to viewport.
            var bounds = map.getBounds();
            if (!bounds) { btn.style.bottom = (bottomSheet.offsetHeight + 16) + 'px'; return; }

            var fullNe = bounds.getNorthEast();
            var fullSw = bounds.getSouthWest();
            var fullLatSpan = fullNe.getLat() - fullSw.getLat();

            // adjusted bottom latitude is adj.sw (because adj.sw is the southern boundary of adjusted area)
            var adjBottomLat = adj.sw.getLat();
            var fracFromTop = (fullNe.getLat() - adjBottomLat) / fullLatSpan;
            var y = mapRect.top + fracFromTop * mapRect.height;

            // place button slightly above adjusted bottom and slightly inset from right
            var bottomPx = window.innerHeight - y + 12; // 12px padding above adjusted bottom
            btn.style.bottom = bottomPx + 'px';
            btn.style.right = '20px';
        }

        function populateBusinessGroupSelect(groups) {
            var businessGroupList = document.getElementById('search-business-group');
            businessGroupList.innerHTML = '<option value="">업종 선택</option>';
            const set = new Set(groups.sort());

            set.forEach(function (item) {
                if (!item) return;
                var option = document.createElement('option');
                option.value = item;
                option.text = item;
                businessGroupList.add(option, null);
            });
        }

        let currentCircle = null; // Variable to store the currently displayed circle

        function moveToStoreLocation() {
            var location = this.querySelector('.store-location').textContent;
            var geocoder = new kakao.maps.services.Geocoder();

            geocoder.addressSearch(location, function (position, status) {
                if (status === kakao.maps.services.Status.OK) {
                    var coords = new kakao.maps.LatLng(position[0].y, position[0].x);
                    map.setLevel(4);
                    map.setCenter(coords);

                    if (currentCircle) {
                        currentCircle.setMap(null);
                    }

                    var circle = new kakao.maps.Circle({
                        center: coords,
                        radius: 80,
                        strokeWeight: 5,
                        strokeColor: '#DAA520',
                        strokeOpacity: 0.9,
                        strokeStyle: 'solid',
                        fillColor: '#FFF8DC',
                        fillOpacity: 0.5
                    });

                    circle.setMap(map); 
                    currentCircle = circle;
                } else {
                    console.warn('리스트 클릭 지오코딩 실패:', location, status);
                }
            });
        }

        function filterStores() {
            var storeList = document.getElementsByClassName('store-info');
            var searchName = document.getElementById('search-name').value.toUpperCase();
            var selectedBusinessGroup = document.getElementById('search-business-group').value;

            Array.from(storeList).forEach(function (storeEl) {
                var name = storeEl.getElementsByClassName('store-name')[0].innerHTML.toUpperCase();
                var businessGroup = storeEl.getElementsByClassName('store-business-group')[0].innerHTML;

                if (name.indexOf(searchName) > -1 && (!selectedBusinessGroup || businessGroup === selectedBusinessGroup)) {
                    storeEl.style.display = "block";
                } else {
                    storeEl.style.display = "none";
                }
            });
        }
    </script>
</body>

</html>
